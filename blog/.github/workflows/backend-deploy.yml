name: Backend CI/CD - AWS EC2 Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"
  pull_request:
    branches:
      - main
    paths:
      - "backend/**"
  workflow_dispatch:

env:
  NODE_VERSION: "18"
  APP_NAME: darslinker-backend

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run linter
        working-directory: backend
        run: npm run lint || echo "Linting completed with warnings"

      - name: Build application
        working-directory: backend
        run: npm run build

      - name: Check build output
        working-directory: backend
        run: |
          if [ -d "dist" ]; then
            echo "Build successful - dist directory created"
            ls -la dist/
          else
            echo "Build failed - dist directory not found"
            exit 1
          fi

  build-and-deploy:
    name: Build and Deploy to AWS EC2
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Build application
        working-directory: backend
        run: npm run build

      - name: Create deployment package
        working-directory: backend
        run: |
          mkdir -p deploy
          cp -r dist package.json package-lock.json deploy/
          cp .env.example deploy/.env.example
          cd deploy
          tar -czf ../backend-deploy.tar.gz .
          cd ..
          rm -rf deploy

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/backend-deploy.tar.gz
          retention-days: 7

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            # Configuration
            APP_DIR="/home/${{ secrets.EC2_USERNAME }}/apps/darslinker-backend"
            BACKUP_DIR="/home/${{ secrets.EC2_USERNAME }}/backups/backend"

            echo "ðŸš€ Starting deployment process..."

            # Create directories if they don't exist
            mkdir -p $APP_DIR
            mkdir -p $BACKUP_DIR

            # Backup current version
            if [ -d "$APP_DIR/dist" ]; then
              echo "ðŸ“¦ Creating backup..."
              BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
              tar -czf $BACKUP_FILE -C $APP_DIR . 2>/dev/null || echo "Backup skipped - first deployment"

              # Keep only last 5 backups
              cd $BACKUP_DIR
              ls -t backup-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
            fi

            cd $APP_DIR

            # Stop current application
            echo "ðŸ›‘ Stopping current application..."
            pm2 stop darslinker-backend 2>/dev/null || echo "App not running"

            # Clean old files
            echo "ðŸ§¹ Cleaning old files..."
            rm -rf dist node_modules package.json package-lock.json

            echo "âœ… Deployment preparation complete"

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          source: "backend/backend-deploy.tar.gz"
          target: "/home/${{ secrets.EC2_USERNAME }}/apps/"
          strip_components: 1

      - name: Extract and start application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/home/${{ secrets.EC2_USERNAME }}/apps/darslinker-backend"

            cd $APP_DIR

            # Extract deployment package
            echo "ðŸ“¦ Extracting deployment package..."
            tar -xzf ../backend-deploy.tar.gz
            rm ../backend-deploy.tar.gz

            # Install production dependencies
            echo "ðŸ“¥ Installing dependencies..."
            npm ci --production

            # Set up environment variables
            if [ ! -f .env ]; then
              echo "âš™ï¸ Creating .env file..."
              cat > .env << 'EOF'
            PORT=${{ secrets.BACKEND_PORT || 5001 }}
            NODE_ENV=production
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            MODERATOR_URL=${{ secrets.MODERATOR_URL }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
            EOF
            fi

            # Start application with PM2
            echo "ðŸš€ Starting application..."
            pm2 start dist/main.js --name darslinker-backend --time --instances 2 --exec-mode cluster || pm2 restart darslinker-backend

            # Save PM2 configuration
            pm2 save

            # Display status
            echo "âœ… Deployment successful!"
            pm2 status
            pm2 logs darslinker-backend --lines 20 --nostream

      - name: Health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            echo "ðŸ¥ Running health check..."
            sleep 10

            # Check if PM2 process is running
            if pm2 status | grep -q "darslinker-backend.*online"; then
              echo "âœ… PM2 process is running"
            else
              echo "âŒ PM2 process is not running"
              pm2 logs darslinker-backend --lines 50 --nostream
              exit 1
            fi

            # Check if port is listening
            PORT=${{ secrets.BACKEND_PORT || 5001 }}
            if netstat -tuln | grep -q ":$PORT "; then
              echo "âœ… Application is listening on port $PORT"
            else
              echo "âŒ Application is not listening on port $PORT"
              exit 1
            fi

            # Try HTTP health check
            if curl -f http://localhost:$PORT/api/blogs > /dev/null 2>&1; then
              echo "âœ… API is responding correctly"
            else
              echo "âš ï¸ API health check failed - check application logs"
              pm2 logs darslinker-backend --lines 50 --nostream
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Backend deployment successful!"
            echo "ðŸ”— Backend URL: https://${{ secrets.EC2_HOST }}/api"
          else
            echo "âŒ Backend deployment failed!"
          fi

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'
    needs: build-and-deploy

    steps:
      - name: Rollback to previous version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/home/${{ secrets.EC2_USERNAME }}/apps/darslinker-backend"
            BACKUP_DIR="/home/${{ secrets.EC2_USERNAME }}/backups/backend"

            echo "â®ï¸ Starting rollback process..."

            # Find latest backup
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup-*.tar.gz 2>/dev/null | head -1)

            if [ -z "$LATEST_BACKUP" ]; then
              echo "âŒ No backup found for rollback"
              exit 1
            fi

            echo "ðŸ“¦ Restoring from: $LATEST_BACKUP"

            # Stop application
            pm2 stop darslinker-backend 2>/dev/null || true

            # Clean current files
            cd $APP_DIR
            rm -rf dist node_modules package.json package-lock.json

            # Restore backup
            tar -xzf $LATEST_BACKUP

            # Install dependencies
            npm ci --production

            # Restart application
            pm2 restart darslinker-backend || pm2 start dist/main.js --name darslinker-backend

            echo "âœ… Rollback completed"
            pm2 status
