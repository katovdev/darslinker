name: Frontend CI/CD - AWS EC2 Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-deploy.yml"
  pull_request:
    branches:
      - main
    paths:
      - "frontend/**"
  workflow_dispatch:

env:
  NODE_VERSION: "18"
  APP_NAME: darslinker-frontend

jobs:
  test:
    name: Test and Build Frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Create test .env file
        working-directory: frontend
        run: |
          cat > .env << EOF
          VITE_API_URL=https://api.example.com/api
          EOF

      - name: Build application
        working-directory: frontend
        run: npm run build

      - name: Check build output
        working-directory: frontend
        run: |
          if [ -d "dist" ]; then
            echo "Build successful - dist directory created"
            ls -la dist/
            du -sh dist/
          else
            echo "Build failed - dist directory not found"
            exit 1
          fi

      - name: Check for build artifacts
        working-directory: frontend/dist
        run: |
          if [ ! -f "index.html" ]; then
            echo "Error: index.html not found in build"
            exit 1
          fi
          echo "âœ… All required files present"

  build-and-deploy:
    name: Build and Deploy to AWS EC2
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Create production .env file
        working-directory: frontend
        run: |
          cat > .env << EOF
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          EOF

      - name: Build application for production
        working-directory: frontend
        run: |
          npm run build
          echo "Build completed at $(date)"

      - name: Optimize build
        working-directory: frontend/dist
        run: |
          echo "ðŸ“Š Build size before optimization:"
          du -sh .

          # Remove source maps in production if needed
          # find . -name "*.map" -type f -delete

          echo "ðŸ“Š Build size after optimization:"
          du -sh .

      - name: Create deployment package
        working-directory: frontend
        run: |
          cd dist
          tar -czf ../frontend-build.tar.gz .
          cd ..
          echo "âœ… Deployment package created"
          ls -lh frontend-build.tar.gz

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/frontend-build.tar.gz
          retention-days: 7

      - name: Prepare deployment on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            # Configuration
            APP_DIR="/var/www/darslinker-frontend"
            BACKUP_DIR="/home/${{ secrets.EC2_USERNAME }}/backups/frontend"

            echo "ðŸš€ Starting deployment preparation..."

            # Create directories with proper permissions
            sudo mkdir -p $APP_DIR
            sudo chown -R ${{ secrets.EC2_USERNAME }}:${{ secrets.EC2_USERNAME }} $APP_DIR
            mkdir -p $BACKUP_DIR

            # Backup current version
            if [ "$(ls -A $APP_DIR)" ]; then
              echo "ðŸ“¦ Creating backup..."
              BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
              tar -czf $BACKUP_FILE -C $APP_DIR . 2>/dev/null || echo "Backup skipped"

              # Keep only last 5 backups
              cd $BACKUP_DIR
              ls -t backup-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
            fi

            # Clean current files
            echo "ðŸ§¹ Cleaning current deployment..."
            sudo rm -rf $APP_DIR/*

            echo "âœ… Preparation complete"

      - name: Copy build to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          source: "frontend/frontend-build.tar.gz"
          target: "/home/${{ secrets.EC2_USERNAME }}/"
          strip_components: 1

      - name: Extract and configure frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/var/www/darslinker-frontend"

            echo "ðŸ“¦ Extracting build files..."
            sudo tar -xzf ~/frontend-build.tar.gz -C $APP_DIR

            # Clean up
            rm ~/frontend-build.tar.gz

            # Set proper permissions
            echo "ðŸ” Setting permissions..."
            sudo chown -R www-data:www-data $APP_DIR
            sudo find $APP_DIR -type f -exec chmod 644 {} \;
            sudo find $APP_DIR -type d -exec chmod 755 {} \;

            # Verify deployment
            echo "âœ… Verifying deployment..."
            if [ -f "$APP_DIR/index.html" ]; then
              echo "âœ… Frontend files deployed successfully"
              ls -la $APP_DIR
            else
              echo "âŒ Deployment verification failed"
              exit 1
            fi

      - name: Configure Nginx
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            # Check if Nginx is installed
            if ! command -v nginx &> /dev/null; then
              echo "âš ï¸ Nginx not found - skipping Nginx configuration"
              exit 0
            fi

            echo "ðŸ”§ Configuring Nginx..."

            # Reload Nginx to apply changes
            sudo nginx -t && sudo systemctl reload nginx

            echo "âœ… Nginx configuration reloaded"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            echo "ðŸ¥ Running health check..."

            APP_DIR="/var/www/darslinker-frontend"

            # Check if files exist
            if [ ! -f "$APP_DIR/index.html" ]; then
              echo "âŒ index.html not found"
              exit 1
            fi

            # Check file permissions
            if [ ! -r "$APP_DIR/index.html" ]; then
              echo "âŒ index.html is not readable"
              exit 1
            fi

            # Check Nginx status
            if command -v nginx &> /dev/null; then
              if sudo systemctl is-active --quiet nginx; then
                echo "âœ… Nginx is running"
              else
                echo "âš ï¸ Nginx is not running"
              fi
            fi

            # Try to access the site
            if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "âœ… Frontend is accessible"
            else
              echo "âš ï¸ Frontend health check warning - site may not be accessible"
            fi

            echo "âœ… Health check completed"

      - name: Clear CDN/CloudFront cache (if applicable)
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            # If you're using CloudFront, add invalidation here
            # aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths "/*"
            echo "ðŸ”„ Cache clearing skipped (configure if using CDN)"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Frontend deployment successful!"
            echo "ðŸ”— Frontend URL: https://${{ secrets.FRONTEND_DOMAIN || secrets.EC2_HOST }}"
          else
            echo "âŒ Frontend deployment failed!"
          fi

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'
    needs: build-and-deploy

    steps:
      - name: Rollback to previous version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/var/www/darslinker-frontend"
            BACKUP_DIR="/home/${{ secrets.EC2_USERNAME }}/backups/frontend"

            echo "â®ï¸ Starting rollback process..."

            # Find latest backup
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup-*.tar.gz 2>/dev/null | head -1)

            if [ -z "$LATEST_BACKUP" ]; then
              echo "âŒ No backup found for rollback"
              exit 1
            fi

            echo "ðŸ“¦ Restoring from: $LATEST_BACKUP"

            # Clean current files
            sudo rm -rf $APP_DIR/*

            # Restore backup
            sudo tar -xzf $LATEST_BACKUP -C $APP_DIR

            # Set permissions
            sudo chown -R www-data:www-data $APP_DIR
            sudo find $APP_DIR -type f -exec chmod 644 {} \;
            sudo find $APP_DIR -type d -exec chmod 755 {} \;

            # Reload Nginx
            if command -v nginx &> /dev/null; then
              sudo systemctl reload nginx
            fi

            echo "âœ… Rollback completed"
            ls -la $APP_DIR
